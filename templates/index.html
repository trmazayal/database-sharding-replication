<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL Benchmark UI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        #output-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 600px; /* Increased height */
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 12px; /* Smaller font size */
            line-height: 1.3; /* Compact line height */
            color: #212529;
        }

        /* Text size classes for user control */
        .text-xs {
            font-size: 10px !important;
            line-height: 1.2 !important;
        }

        .text-sm {
            font-size: 12px !important;
            line-height: 1.3 !important;
        }

        .text-md {
            font-size: 14px !important;
            line-height: 1.4 !important;
        }

        .text-lg {
            font-size: 16px !important;
            line-height: 1.5 !important;
        }

        /* Make the container expand to full height on larger screens */
        @media (min-height: 900px) {
            #output-container {
                height: 700px;
            }
        }

        .benchmark-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .running {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .completed {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        /* Scrollbar styling for better visibility */
        #output-container::-webkit-scrollbar {
            width: 8px;
        }

        #output-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #output-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #output-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Line highlighting for easier reading */
        #output-container .highlight {
            background-color: #fffbcc;
        }

        /* Adjust card to take more vertical space */
        .card-content {
            min-height: 800px;
        }

        /* Button group for text size controls */
        .btn-group-sm .btn {
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Output header controls */
        .output-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .output-controls h5 {
            margin-bottom: 0;
        }

        .output-controls .btn-toolbar {
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1>PostgreSQL Benchmark UI</h1>

        <div class="row">
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#home">Run Benchmark</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/results">Results</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/compare_results">Compare</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body card-content">
                        <div id="status-container">
                            {% if benchmark.running %}
                            <div class="benchmark-status running">
                                <h5>Benchmark Running</h5>
                                <p>
                                    <strong>Type:</strong> {{ benchmark.type }}<br>
                                    <strong>Started:</strong> {{ benchmark.start_time }}<br>
                                    <strong>Users:</strong> {{ benchmark.users }} |
                                    <strong>Spawn Rate:</strong> {{ benchmark.spawn_rate }} |
                                    <strong>Run Time:</strong> {{ benchmark.run_time }}s<br>
                                    {% if benchmark.type == 'mixed' %}
                                    <strong>Read/Write:</strong> {{ benchmark.read_weight }}% / {{ benchmark.write_weight }}%
                                    {% endif %}
                                </p>
                            </div>
                            {% elif benchmark.end_time %}
                            <div class="benchmark-status completed">
                                <h5>Benchmark Completed</h5>
                                <p>
                                    <strong>Type:</strong> {{ benchmark.type }}<br>
                                    <strong>Started:</strong> {{ benchmark.start_time }}<br>
                                    <strong>Finished:</strong> {{ benchmark.end_time }}<br>
                                    {% if benchmark.results_dir %}
                                    <strong>Results:</strong> {{ benchmark.results_dir }}
                                    {% endif %}
                                </p>
                                <a href="/results" class="btn btn-sm btn-primary">View Results</a>
                            </div>
                            {% endif %}
                        </div>

                        {% if benchmark.running or benchmark.output %}
                        <div class="output-controls">
                            <h5>Output</h5>
                            <div class="btn-toolbar">
                                <div class="btn-group btn-group-sm me-2">
                                    <button type="button" class="btn btn-outline-secondary text-size" data-size="xs">XS</button>
                                    <button type="button" class="btn btn-outline-secondary text-size active" data-size="sm">S</button>
                                    <button type="button" class="btn btn-outline-secondary text-size" data-size="md">M</button>
                                    <button type="button" class="btn btn-outline-secondary text-size" data-size="lg">L</button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" id="toggle-autoscroll">Autoscroll: ON</button>
                            </div>
                        </div>
                        <div id="output-container" class="text-sm">
                            {% for line in benchmark.output %}
                            {{ line }}
                            {% endfor %}
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <button id="clear-output" class="btn btn-sm btn-outline-danger me-2">Clear</button>
                            <button id="download-output" class="btn btn-sm btn-outline-primary">Download</button>
                        </div>
                        {% endif %}

                        {% if not benchmark.running %}
                        <h5 class="mt-4">Run New Benchmark</h5>
                        <form action="/start_benchmark" method="post">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="benchmark_type" class="form-label">Benchmark Type</label>
                                    <select name="benchmark_type" id="benchmark_type" class="form-select" onchange="toggleReadWriteRatio()">
                                        <option value="mixed">Mixed (Read/Write)</option>
                                        <option value="read">Read Only</option>
                                        <option value="write">Write Only</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="users" class="form-label">Users</label>
                                    <input type="number" name="users" id="users" class="form-control" value="100" min="1" max="1000">
                                </div>
                                <div class="col-md-4">
                                    <label for="spawn_rate" class="form-label">Spawn Rate</label>
                                    <input type="number" name="spawn_rate" id="spawn_rate" class="form-control" value="10" min="1" max="100">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="run_time" class="form-label">Run Time (seconds)</label>
                                    <input type="number" name="run_time" id="run_time" class="form-control" value="60" min="10" max="3600">
                                </div>
                                <div class="col-md-4" id="read_weight_container">
                                    <label for="read_weight" class="form-label">Read Weight (%)</label>
                                    <input type="number" name="read_weight" id="read_weight" class="form-control" value="80" min="0" max="100" onchange="updateWriteWeight()">
                                </div>
                                <div class="col-md-4" id="write_weight_container">
                                    <label for="write_weight" class="form-label">Write Weight (%)</label>
                                    <input type="number" name="write_weight" id="write_weight" class="form-control" value="20" min="0" max="100" onchange="updateReadWeight()">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">Start Benchmark</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Benchmark Information</h5>
                    </div>
                    <div class="card-body">
                        <h6>Available Modes</h6>
                        <ul>
                            <li><strong>Mixed Mode:</strong> Custom read/write ratio</li>
                            <li><strong>Read Only:</strong> 100% read operations</li>
                            <li><strong>Write Only:</strong> 100% write operations</li>
                        </ul>

                        <h6>Parameters</h6>
                        <ul>
                            <li><strong>Users:</strong> Simulated concurrent users</li>
                            <li><strong>Spawn Rate:</strong> Users per second to start</li>
                            <li><strong>Run Time:</strong> Duration of the test in seconds</li>
                            <li><strong>Read/Write Weight:</strong> Percentage of operations</li>
                        </ul>

                        <h6>Tips</h6>
                        <ul>
                            <li>For write-heavy tests, use fewer users</li>
                            <li>For read-heavy tests, you can use more users</li>
                            <li>Make sure your database can handle the load</li>
                            <li>Spatial queries are included in the read category</li>
                            <li>Use text size controls to fit more output</li>
                        </ul>

                        <div class="mt-4">
                            <h6>Output Controls</h6>
                            <div class="small text-muted mb-2">
                                <p class="mb-1">
                                    <i class="bi bi-arrows-collapse"></i> Use text size buttons to adjust output font size
                                </p>
                                <p class="mb-1">
                                    <i class="bi bi-arrow-down-square"></i> Toggle autoscroll to freeze output view
                                </p>
                                <p class="mb-0">
                                    <i class="bi bi-download"></i> Download to save full output as text file
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let outputLastLine = 0;
        let autoScroll = true;

        function toggleReadWriteRatio() {
            const benchmarkType = document.getElementById('benchmark_type').value;
            const readWeightContainer = document.getElementById('read_weight_container');
            const writeWeightContainer = document.getElementById('write_weight_container');

            if (benchmarkType === 'mixed') {
                readWeightContainer.style.display = 'block';
                writeWeightContainer.style.display = 'block';
            } else {
                readWeightContainer.style.display = 'none';
                writeWeightContainer.style.display = 'none';
            }
        }

        function updateWriteWeight() {
            const readWeight = parseInt(document.getElementById('read_weight').value);
            document.getElementById('write_weight').value = 100 - readWeight;
        }

        function updateReadWeight() {
            const writeWeight = parseInt(document.getElementById('write_weight').value);
            document.getElementById('read_weight').value = 100 - writeWeight;
        }

        function refreshOutput() {
            fetch('/benchmark_output?since=' + outputLastLine)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('output-container');
                    if (data.output.length > 0) {
                        data.output.forEach(line => {
                            // Highlight important lines
                            if (line.includes('throughput') || line.includes('latency') ||
                                line.includes('metrics') || line.includes('success rate')) {
                                const span = document.createElement('span');
                                span.className = 'highlight';
                                span.textContent = line + '\n';
                                container.appendChild(span);
                            } else {
                                container.appendChild(document.createTextNode(line + '\n'));
                            }
                        });

                        if (autoScroll) {
                            container.scrollTop = container.scrollHeight;
                        }
                        outputLastLine = data.count;
                    }

                    if (data.running) {
                        setTimeout(refreshOutput, 1000);
                    } else {
                        // Refresh the page when the benchmark finishes
                        setTimeout(() => window.location.reload(), 2000);
                    }
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Text size controls
            const textSizeButtons = document.querySelectorAll('.text-size');
            const outputContainer = document.getElementById('output-container');

            textSizeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove all size classes
                    outputContainer.classList.remove('text-xs', 'text-sm', 'text-md', 'text-lg');
                    // Add selected size class
                    outputContainer.classList.add('text-' + this.dataset.size);

                    // Update active button state
                    textSizeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // Save preference in localStorage
                    localStorage.setItem('preferredTextSize', this.dataset.size);
                });
            });

            // Load preferred text size from localStorage
            const savedSize = localStorage.getItem('preferredTextSize');
            if (savedSize) {
                outputContainer.classList.remove('text-xs', 'text-sm', 'text-md', 'text-lg');
                outputContainer.classList.add('text-' + savedSize);

                textSizeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.size === savedSize) {
                        btn.classList.add('active');
                    }
                });
            }

            // Toggle autoscroll functionality
            const toggleButton = document.getElementById('toggle-autoscroll');
            if (toggleButton) {
                toggleButton.addEventListener('click', function() {
                    autoScroll = !autoScroll;
                    toggleButton.textContent = `Autoscroll: ${autoScroll ? 'ON' : 'OFF'}`;
                });
            }

            // Clear output functionality
            const clearButton = document.getElementById('clear-output');
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    const container = document.getElementById('output-container');
                    if (container) {
                        container.innerHTML = '';
                    }
                });
            }

            // Download output functionality
            const downloadButton = document.getElementById('download-output');
            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                    const container = document.getElementById('output-container');
                    if (container) {
                        const text = container.innerText;
                        const blob = new Blob([text], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `benchmark_output_${new Date().toISOString().replace(/:/g, '-')}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                });
            }

            // Initialize form
            toggleReadWriteRatio();
        });

        // Start polling for output updates if a benchmark is running
        {% if benchmark.running %}
        document.addEventListener('DOMContentLoaded', function() {
            outputLastLine = {{ benchmark.output|length }};
            refreshOutput();
        });
        {% endif %}
    </script>
</body>
</html>
